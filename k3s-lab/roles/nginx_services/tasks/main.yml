- name: Deploy 20 nginx microservices
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', 'nginx-deploy.yaml.j2') }}"
  loop: "{{ range(1, 21) | list }}"
  loop_control:
    loop_var: index

- name: Wait for nginx pods to be Ready
  kubernetes.core.k8s_info:
    kind: Pod
    label_selectors:
      - "app in ({{ nginx_labels }})"
  vars:
    nginx_labels: "{{ range(1, 21) | map('regex_replace', '^(.*)$', 'nginx-svc-\\1') | join(',') }}"
  register: pods
  retries: 20
  delay: 10
  until: >
    pods.resources | length == 20 and
    (pods.resources | map(attribute='status.containerStatuses') | list
     | flatten | selectattr('ready', 'equalto', true) | list | length) == 20

- name: Create ingress to expose nginx microservices on /svc-N
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', 'nginx-ingress.yaml.j2') }}"
