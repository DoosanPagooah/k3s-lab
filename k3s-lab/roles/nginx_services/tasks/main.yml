- name: Deploy 20 nginx microservices
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', 'nginx-deploy.yaml.j2') }}"
  loop: "{{ range(1, 21) | list }}"
  loop_control:
    loop_var: index

- name: Wait for 20 nginx pods to be Running
  ansible.builtin.shell: |
    KUBECONFIG=/root/.kube/config \
      kubectl get pods -n default -l svc-id \
      --field-selector=status.phase=Running \
      --no-headers 2>/dev/null | wc -l
  register: running_pods
  retries: 30
  delay: 10
  until: (running_pods.stdout | int) >= 20
  changed_when: false

- name: Create ingress to expose nginx microservices on /svc-N
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', 'nginx-ingress.yaml.j2') }}"
